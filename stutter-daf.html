<!doctype html>
<html lang="ja">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ãƒ–ãƒ©ã‚¦ã‚¶DAFï¼ˆé…å»¶è´è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼‰</title>
<style>
  body { font-family: system-ui, sans-serif; max-width: 720px; margin: 2rem auto; padding: 0 1rem; }
  .card { border: 1px solid #ddd; border-radius: 12px; padding: 1rem 1.2rem; margin-bottom: 1rem; }
  label { display: block; margin: .5rem 0 .25rem; font-weight: 600; }
  input[type="range"] { width: 100%; }
  button { padding: .6rem 1rem; border: 0; border-radius: 10px; background: #4f46e5; color: #fff; font-weight: 700; }
  button[disabled] { background: #a5b4fc; }
  .note { font-size: .9rem; color: #444; }
</style>
<body>
  <h1>ãƒ–ãƒ©ã‚¦ã‚¶DAF ğŸ§</h1>
  <p class="note">ãƒ˜ãƒƒãƒ‰ãƒ›ãƒ³ã‚’ä½¿ã£ã¦ã­ã€‚éŸ³å£°ã¯ç«¯æœ«å†…ã§å‡¦ç†ã—ã€ã‚µãƒ¼ãƒãƒ¼ã«ã¯é€ä¿¡ã•ã‚Œã¾ã›ã‚“ï¼ˆéŒ²éŸ³ã‚‚ã—ã¾ã›ã‚“ï¼‰ã€‚åŒ»ç™‚çš„è¨ºæ–­ãƒ»æ²»ç™‚ã‚’æä¾›ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>

  <div class="card">
    <label for="delay">é…å»¶æ™‚é–“: <span id="delayLabel">150</span> ms</label>
    <input id="delay" type="range" min="0" max="300" value="150" step="10" />
    <label for="gain">éŸ³é‡: <span id="gainLabel">80</span> %</label>
    <input id="gain" type="range" min="0" max="100" value="80" step="1" />
    <div style="margin-top: .8rem;">
      <button id="startBtn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
      <button id="stopBtn" disabled>ã‚¹ãƒˆãƒƒãƒ—</button>
    </div>
    <p class="note">ã‚³ãƒ„: ã‚¨ã‚³ãƒ¼ãŒæ°—ã«ãªã‚‹æ™‚ã¯é…å»¶ã‚’çŸ­ãã€éŸ³é‡ã‚’ä¸‹ã’ã¦ã­ã€‚ç’°å¢ƒéŸ³ãŒå¤§ãã„å ´æ‰€ã§ã¯åŠ¹æœãŒå¼±ãæ„Ÿã˜ã‚‹ã“ã¨ãŒã‚ã‚‹ã‚ˆã€‚</p>
  </div>

  <div class="card">
    <details>
      <summary>ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã¨åŒæ„</summary>
      <p class="note">ã“ã®ãƒ„ãƒ¼ãƒ«ã¯éŸ³å£°ã‚’å¤–éƒ¨ã«é€ä¿¡ã›ãšã€éŒ²éŸ³ã‚„ä¿å­˜ã‚‚ã—ã¾ã›ã‚“ã€‚è¨­å®šã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚åˆ©ç”¨ã‚’ç¶šã‘ã‚‹ã“ã¨ã§ã€ã“ã®æ–¹é‡ã«åŒæ„ã—ãŸã¨ã¿ãªã—ã¾ã™ã€‚</p>
    </details>
  </div>

<script>
let audioCtx, mediaStream, mediaNode, delayNode, gainNode;

const delaySlider = document.getElementById('delay');
const gainSlider = document.getElementById('gain');
const delayLabel = document.getElementById('delayLabel');
const gainLabel = document.getElementById('gainLabel');
const startBtn = document.getElementById('startBtn');
const stopBtn  = document.getElementById('stopBtn');

// ãƒ©ãƒ™ãƒ«æ›´æ–°
function updateLabels() {
  delayLabel.textContent = delaySlider.value;
  gainLabel.textContent = gainSlider.value;
}
delaySlider.addEventListener('input', () => {
  if (delayNode) delayNode.delayTime.value = Number(delaySlider.value) / 1000;
  updateLabels();
});
gainSlider.addEventListener('input', () => {
  if (gainNode) gainNode.gain.value = Number(gainSlider.value) / 100;
  updateLabels();
});
updateLabels();

// é–‹å§‹
startBtn.addEventListener('click', async () => {
  startBtn.disabled = true;
  try {
    mediaStream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false }, video: false });

    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const maxDelay = 1.0; // 1ç§’ã¾ã§
    delayNode = audioCtx.createDelay(maxDelay);
    gainNode  = audioCtx.createGain();

    delayNode.delayTime.value = Number(delaySlider.value) / 1000; // ç§’
    gainNode.gain.value       = Number(gainSlider.value) / 100;

    mediaNode = audioCtx.createMediaStreamSource(mediaStream);

    // Graph: mic -> delay -> gain -> output
    mediaNode.connect(delayNode).connect(gainNode).connect(audioCtx.destination);

    stopBtn.disabled = false;
  } catch (err) {
    alert('ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
    startBtn.disabled = false;
  }
});

// åœæ­¢
stopBtn.addEventListener('click', async () => {
  stopBtn.disabled = true;
  try {
    if (mediaStream) {
      mediaStream.getTracks().forEach(t => t.stop());
      mediaStream = null;
    }
    if (audioCtx) {
      await audioCtx.close();
      audioCtx = null;
    }
  } finally {
    startBtn.disabled = false;
  }
});
</script>
</body>
</html>
